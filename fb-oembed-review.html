<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FB oEmbed Review – Exploride</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:24px;line-height:1.45;background:#fafafa}
    .box{max-width:860px;margin:0 auto}
    h1{margin:0 0 8px}
    .card{background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:16px}
    .log{background:#0b0b0b;color:#9dff9d;padding:12px;border-radius:8px;white-space:pre-wrap;overflow:auto;min-height:120px}
    iframe{max-width:100%}
    .muted{color:#666}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .row>*{flex:1 1 360px}
  </style>
</head>
<body>
<div class="box">
  <h1>Facebook oEmbed Review</h1>
  <p class="muted">This page demonstrates our use of <b>Meta oEmbed Read</b>. It requests
     Graph API oEmbed via our Cloudflare Worker and renders the returned HTML.
     If oEmbed is not yet approved (error <code>#10</code>), the page automatically falls back
     to Meta’s official Plugin (<code>post.php</code>/<code>video.php</code>), so you will always see the content.</p>

  <div class="row">
    <div class="card">
      <h2 style="margin-top:0">Rendered embed</h2>
      <div id="host" style="min-height:320px;border:1px dashed #ddd;border-radius:8px;padding:8px;background:#fff"></div>
    </div>

    <div class="card">
      <h2 style="margin-top:0">Debug</h2>
      <div id="debug" class="log">Loading…</div>
      <p class="muted" style="margin-top:8px">
        Tip: You can override the content with a query parameter:
        <br> <code>?url=https://www.facebook.com/…</code>
      </p>
    </div>
  </div>
</div>

<script>
(function(){
  var FB_OEMBED_API = 'https://fb-feed.eksplorajder.workers.dev/api/fb/oembed';
  var DEFAULT_VIDEO = 'https://www.facebook.com/1189465589870011/videos/796100049443163';
  var DEFAULT_POST  = 'https://www.facebook.com/ExploRideURBEX/posts/pfbid0BVAooFADTPMUC9mZLFt3Cj4wcEeeRjsUb71sbX7EjeWKyHnEdr2Y3BvjwUoM4s3Gl';

  function qs(name){
    var m = location.search.match(new RegExp('[?&]'+name+'=([^&]+)'));
    return m ? decodeURIComponent(m[1]) : null;
  }
  var PERMALINK = qs('url') || DEFAULT_VIDEO;

  function setlog(t){ document.getElementById('debug').textContent = t; }
  function logln(t){
    var el = document.getElementById('debug');
    el.textContent = (el.textContent ? el.textContent + '\n' : '') + t;
  }

  function buildPlugin(permalink, maxwidth){
    maxwidth = maxwidth || 780;
    var isVideo = /\/(videos|reel)\//i.test(permalink);
    var src = new URL(isVideo ? 'https://www.facebook.com/plugins/video.php'
                              : 'https://www.facebook.com/plugins/post.php');
    src.searchParams.set('href', permalink);
    src.searchParams.set('width', String(maxwidth));
    if (isVideo) src.searchParams.set('show_text', 'false');
    var h = isVideo ? Math.round(maxwidth * 9 / 16) : 600;
    return '<iframe src="' + src.toString() + '" width="' + maxwidth + '" height="' + h + '"' +
           ' style="border:none;overflow:hidden" scrolling="no" frameborder="0"' +
           ' allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"' +
           ' allowfullscreen></iframe>';
  }

  var host = document.getElementById('host');
  setlog('Requesting oEmbed via Worker...');
  var u = new URL(FB_OEMBED_API);
  u.searchParams.set('url', PERMALINK);
  u.searchParams.set('maxwidth', '780');
  u.searchParams.set('omitscript', 'true');

  fetch(u.toString(), { credentials: 'omit' })
    .then(function(res){ logln('HTTP ' + res.status); return res.json().catch(function(){ return {}; }); })
    .then(function(data){
      logln('Response: ' + JSON.stringify(data));
      if (data && data.html) {
        host.innerHTML = data.html; // official oEmbed HTML
      } else {
        host.innerHTML = buildPlugin(PERMALINK, 780); // fallback plugin
        logln('Fallback rendered via Facebook Plugin (post.php/video.php).');
      }
    })
    .catch(function(e){
      logln('Error: ' + (e && e.message ? e.message : e));
      host.innerHTML = buildPlugin(PERMALINK, 780);
    });
})();
</script>

</body>
</html>
